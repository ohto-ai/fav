name: Auto Process Add Favorite Issue

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process-new-collection:
    # Only process issues with "add-favorite" label
    if: github.event.label.name == 'add-favorite'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Parse issue and add to data.js
        id: parse
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueBody = context.payload.issue.body;
            const issueNumber = context.payload.issue.number;
            
            console.log('Issue body:', issueBody);
            
            // 解析 Issue 内容
            let title, icon, description, tags, content;
            
            // Method 1: Try parsing YAML format (generated from website frontend)
            const yamlMatch = issueBody.match(/```yaml\s*\ntitle:\s*(.+?)\nicon:\s*(.+?)\ndescription:\s*(.+?)\ntags:\s*(.+?)\n```/s);
            
            if (yamlMatch) {
              // Parse from YAML format
              title = yamlMatch[1].trim();
              icon = yamlMatch[2].trim();
              description = yamlMatch[3].trim();
              tags = yamlMatch[4].trim().split(',').map(t => t.trim());
              
              // Extract Markdown content (support both English and Chinese headers)
              let contentMatch = issueBody.match(/## Detailed Content\s*\n\s*```markdown\s*\n([\s\S]+?)```/);
              if (!contentMatch) {
                contentMatch = issueBody.match(/## 详细内容\s*\n\s*```markdown\s*\n([\s\S]+?)```/);
              }
              content = contentMatch ? contentMatch[1].trim() : '';
            } else {
              // Method 2: Try parsing GitHub Issue form format
              const formData = {};
              
              // Parse form submission format (support both Chinese and English labels)
              const titleMatch = issueBody.match(/### 标题\s*\n\s*(.+?)(?=\n###|\n\n|$)/s);
              const iconMatch = issueBody.match(/### 图标\s*\n\s*(.+?)(?=\n###|\n\n|$)/s);
              const descMatch = issueBody.match(/### 描述\s*\n\s*(.+?)(?=\n###|\n\n|$)/s);
              const tagsMatch = issueBody.match(/### 标签\s*\n\s*(.+?)(?=\n###|\n\n|$)/s);
              const contentMatch = issueBody.match(/### 详细内容\s*\n\s*([\s\S]+?)(?=\n###|$)/s);
              
              if (!titleMatch || !iconMatch || !descMatch || !tagsMatch || !contentMatch) {
                throw new Error('Unable to parse issue format. Please ensure you are using the correct template.');
              }
              
              title = titleMatch[1].trim();
              icon = iconMatch[1].trim();
              description = descMatch[1].trim();
              tags = tagsMatch[1].trim().split(',').map(t => t.trim());
              content = contentMatch[1].trim();
            }
            
            console.log('Parsed data:', { title, icon, description, tags, content: content.substring(0, 100) });
            
            // 读取 data.js 文件
            const fs = require('fs');
            const dataContent = fs.readFileSync('data.js', 'utf8');
            
            // 提取现有数据并找到最大 ID
            const dataMatch = dataContent.match(/const collectionsData = \[([\s\S]*)\];/);
            if (!dataMatch) {
              throw new Error('无法解析 data.js 文件');
            }
            
            // 找到最大 ID
            const idMatches = dataContent.matchAll(/id:\s*(\d+)/g);
            let maxId = 0;
            for (const match of idMatches) {
              maxId = Math.max(maxId, parseInt(match[1]));
            }
            const newId = maxId + 1;
            
            console.log('New ID:', newId);
            
            // 转义特殊字符
            const escapeStr = (str) => str.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
            
            // 生成新的收藏对象代码
            const newItem = `    {
                    id: ${newId},
                    title: "${title.replace(/"/g, '\\"')}",
                    icon: "${icon.replace(/"/g, '\\"')}",
                    description: "${description.replace(/"/g, '\\"')}",
                    tags: [${tags.map(t => `"${t.replace(/"/g, '\\"')}"`).join(', ')}],
                    content: \`
            ${content}
                    \`
                }`;
            
            // 在数组末尾添加新项
            const lastItemIndex = dataContent.lastIndexOf('}');
            const beforeLastItem = dataContent.substring(0, lastItemIndex + 1);
            const afterLastItem = dataContent.substring(lastItemIndex + 1);
            
            const newDataContent = beforeLastItem + ',\n' + newItem + afterLastItem;
            
            // 写入文件
            fs.writeFileSync('data.js', newDataContent, 'utf8');
            
            console.log('Successfully added new collection to data.js');
            
            // 返回信息用于后续步骤
            return {
              title,
              newId,
              issueNumber
            };
      
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add Favorite: ${{ fromJSON(steps.parse.outputs.result).title }} (#${{ github.event.issue.number }})"
          branch: auto-add-collection-${{ github.event.issue.number }}
          delete-branch: true
          title: "Add Favorite: ${{ fromJSON(steps.parse.outputs.result).title }}"
          body: |
            This PR automatically processes the add favorite request submitted in Issue #${{ github.event.issue.number }}.
            
            ## New Content
            
            - **Title**: ${{ fromJSON(steps.parse.outputs.result).title }}
            - **ID**: ${{ fromJSON(steps.parse.outputs.result).newId }}
            
            ## Checklist
            
            - [ ] Verify content format is correct
            - [ ] Confirm no duplicates
            - [ ] Check if tags are appropriate
            
            Closes #${{ github.event.issue.number }}
          labels: |
            auto-generated
            add-favorite
      
      - name: Comment on issue
        if: steps.cpr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = '${{ steps.cpr.outputs.pull-request-number }}';
            const issueNumber = context.payload.issue.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `✅ Pull Request #${prNumber} has been automatically created to add this favorite.\n\nPlease wait for review and merge.`
            });
      
      - name: Comment on error
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `❌ Automatic processing failed. Please check if the issue format is correct, or manually add it to the data.js file.\n\nView error details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });
